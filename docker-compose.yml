version: '3.8'

services:
  swarm-server:
    image: swarmmap:cuda10.2_with_example
    container_name: swarm-server
    hostname: swarm-server
    networks:
      - swarmmap-network
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    volumes:
      # Mount EuRoC dataset from Windows
      - C:\Users\sj99\Desktop\EuRoC:/dataset
      # Mount startup script
      - ./docker/start-server.sh:/start-server.sh:ro
      # Mount output directory for maps and trajectories
      - ./output:/opt/SwarmMap/output
    working_dir: /opt/SwarmMap
    command: ["/bin/bash", "/start-server.sh"]
    ports:
      - "10088:10088"
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
      - LD_LIBRARY_PATH=/opt/SwarmMap/lib:/opt/SwarmMap/code/Thirdparty/DBoW2/lib:/opt/SwarmMap/code/Thirdparty/g2o/lib:/usr/local/lib:/usr/local/nvidia/lib:/usr/local/nvidia/lib64

  swarm-client-1:
    image: swarmmap:cuda10.2_with_example
    container_name: swarm-client-1
    hostname: swarm-client-1
    networks:
      - swarmmap-network
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    volumes:
      # Mount EuRoC dataset from Windows
      - C:\Users\sj99\Desktop\EuRoC:/dataset
      # Mount client config with HOST: 'swarm-server'
      - ./docker/client.yaml:/opt/SwarmMap/config/client.yaml:ro
      # Mount startup script
      - ./docker/start-client.sh:/start-client.sh:ro
      # Mount output directory
      - ./output:/opt/SwarmMap/output
    working_dir: /opt/SwarmMap
    command: ["/bin/bash", "/start-client.sh"]
    depends_on:
      - swarm-server
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
      - LD_LIBRARY_PATH=/opt/SwarmMap/lib:/opt/SwarmMap/code/Thirdparty/DBoW2/lib:/opt/SwarmMap/code/Thirdparty/g2o/lib:/usr/local/lib:/usr/local/nvidia/lib:/usr/local/nvidia/lib64

  # Uncomment for additional clients
  # swarm-client-2:
  #   image: swarmmap:latest
  #   container_name: swarm-client-2
  #   hostname: swarm-client-2
  #   networks:
  #     - swarmmap-network
  #   deploy:
  #     resources:
  #       reservations:
  #         devices:
  #           - driver: nvidia
  #             count: all
  #             capabilities: [gpu]
  #   volumes:
  #     - ./dataset:/dataset:ro
  #     - ./docker/client-2.yaml:/config/client.yaml:ro
  #     - ./code/Vocabulary:/vocabulary:ro
  #     - ./output:/output
  #   working_dir: /opt/SwarmMap
  #   command: >
  #     /opt/SwarmMap/bin/swarm_client
  #     --voc /vocabulary/ORBvoc.bin
  #     --dataset /config/client.yaml
  #     --log info
  #     --viewer 0
  #     --mapviewer 0
  #   depends_on:
  #     - swarm-server
  #   environment:
  #     - NVIDIA_VISIBLE_DEVICES=all
  #     - NVIDIA_DRIVER_CAPABILITIES=compute,utility

networks:
  swarmmap-network:
    driver: bridge
    name: swarmmap-network
